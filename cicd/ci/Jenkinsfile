pipeline {
    agent any

    environment {
        GITHUB_CREDENTIALS_ID = 'github'
        REPO_URL = 'https://github.com/Jenium-lab/exchangerate.git'
        SONAR_AUTH_TOKEN = credentials('sonarqube')
        DOCKER_CREDENTIALS_ID = 'dockerhub'
        IMAGE_NAME = 'srijan581/exchangerate'
        GRADLE_HOME = '/opt/gradle' // Ensure Gradle is pre-installed in this path
        PATH = "$GRADLE_HOME/bin:$PATH"
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/main']],
                        userRemoteConfigs: [
                            [url: REPO_URL, credentialsId: GITHUB_CREDENTIALS_ID]
                        ]
                    ])
                }
            }
        }

        stage('Setup Gradle') {
            steps {
                script {
                    // Check if Gradle is installed, otherwise download and install
                    def gradleCheck = sh(script: 'gradle -v', returnStatus: true)
                    if (gradleCheck != 0) {
                        echo "Gradle not found, downloading Gradle..."
                        sh 'wget https://services.gradle.org/distributions/gradle-8.12.1-bin.zip -P /tmp'
                        sh 'unzip /tmp/gradle-8.12.1-bin.zip -d /opt'
                        sh 'ln -s /opt/gradle-8.12.1 /opt/gradle'
                    } else {
                        echo "Gradle is already installed."
                    }
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    echo "Building the project..."
                    sh 'chmod +x gradlew'
                    sh './gradlew build -x test -x runSmokeTest'
                }
            }
        }

        stage('Unit Test') {
            steps {
                script {
                    echo "Running unit tests..."
                    sh './gradlew test'
                }
            }
        }

        stage('Smoke Test') {
            steps {
                script {
                    echo "Running smoke tests..."
                    sh './gradlew runSmokeTest'
                }
            }
        }

        stage('Code Analysis') {
            steps {
                script {
                    echo "Running SonarQube analysis..."
                    withSonarQubeEnv('SonarQube') {
                        sh './gradlew sonar -Dsonar.login=${env.SONAR_AUTH_TOKEN}'
                    }

                    timeout(time: 5, unit: 'MINUTES') {
                        def qualityGate = waitForQualityGate()
                        if (qualityGate.status != 'OK') {
                            error "SonarQube Quality Gate failed: ${qualityGate.status}"
                        } else {
                            echo "SonarQube Quality Gate passed."
                        }
                    }
                }
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                script {
                    echo "Building and pushing Docker image..."
                    def commitHash = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    def imageTag = "${commitHash}"
                    def imageNameWithTag = "${IMAGE_NAME}:${imageTag}"

                    echo "Building Docker image with tag: ${imageTag}"

                    docker.withRegistry('https://index.docker.io/v1/', DOCKER_CREDENTIALS_ID) {
                        def image = docker.build(imageNameWithTag)
                        image.push()
                    }

                    env.COMMIT_HASH = commitHash
                }
            }
        }

        stage('Deploy on Dev') {
            steps {
                script {
                    echo "Deploying Docker image to Dev..."
                    def containerName = "exchangerates-container"
                    def imageTag = env.COMMIT_HASH

                    sh """
                        docker ps -q -f name=${containerName} | xargs -r docker stop
                        docker ps -a -q -f name=${containerName} | xargs -r docker rm
                    """

                    sh """
                        docker run -d --name ${containerName} -p 8090:8080 ${IMAGE_NAME}:${imageTag}
                    """
                }
            }
        }

        stage('Health Check on Dev') {
            steps {
                script {
                    echo "Waiting for application to be ready..."
                    sleep(time: 30, unit: "SECONDS")

                    def healthUrl = "http://localhost:8090/actuator/health"

                    def response = sh(script: "curl -s ${healthUrl}", returnStdout: true).trim()
                    echo "Health check response: ${response}"

                    def jsonResponse = readJSON text: response
                    def status = jsonResponse.status

                    if (status == 'UP') {
                        echo 'Application is healthy.'
                    } else {
                        error 'Health check failed: Application is not healthy.'
                    }
                }
            }
        }

        stage('Update Image Tag in Kubernetes') {
            steps {
                script {
                    echo "Updating image tag in Kubernetes deployment..."

                    def imageTag = env.COMMIT_HASH

                    // Sync latest main branch
                    sh 'git fetch origin main'
                    sh 'git reset --hard origin/main'

                    // Update the image tag in values.yaml
                    sh """
                        sed -i 's/tag:.*/tag: ${imageTag}/' k8chart/values.yaml
                    """

                    withCredentials([usernamePassword(credentialsId: GITHUB_CREDENTIALS_ID, usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                        sh """
                            git config --global user.email "kodedge-bot-ci@kodedge.com"
                            git config --global user.name "kodedge-bot-ci"
                            git add k8chart/values.yaml
                            git commit -m "Update image tag to version ${imageTag}"
                            git push https://${GIT_USER}:${GIT_PASS}@github.com/Jenium-lab/exchangerate.git main
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Cleaning up workspace...'
            cleanWs()
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}
